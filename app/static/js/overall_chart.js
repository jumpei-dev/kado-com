// ‰∏ÄË¶ßÁîªÈù¢Áî®„ÅÆÂÖ®‰ΩìÁ®ºÂÉçÊé®Áßª„Ç∞„É©„Éï
let overallChart = null;
let currentPeriod = '7days';
let currentFilters = {
    area: 'all',
    genre: 'all'
};
let isInitializing = false;

// „Ç∞„É©„ÉïÂàùÊúüÂåñ
function initOverallChart() {
    if (isInitializing) {
        console.log('‚è≥ ÂÖ®‰ΩìÁ®ºÂÉçÊé®Áßª„Ç∞„É©„ÉïÂàùÊúüÂåñ‰∏≠„ÅÆ„Åü„ÇÅ„ÄÅ„Çπ„Ç≠„ÉÉ„Éó');
        return;
    }
    
    isInitializing = true;
    console.log('üìä ÂÖ®‰ΩìÁ®ºÂÉçÊé®Áßª„Ç∞„É©„Éï„ÇíÂàùÊúüÂåñ‰∏≠...');
    
    // ÂàùÊúü„É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
    const initialLoading = document.getElementById('initial-overall-loading');
    if (initialLoading) {
        initialLoading.style.display = 'none';
    }
    
    // ÂàùÊúü„Éï„Ç£„É´„Çø„ÉºÂÄ§„ÇíÂèñÂæó
    updateFiltersFromUI();
    
    // „Ç∞„É©„Éï„ÇíË™≠„ÅøËæº„Åø
    loadOverallChart();
}

// UI„Åã„Çâ„Éï„Ç£„É´„Çø„ÉºÂÄ§„ÇíÊõ¥Êñ∞
function updateFiltersFromUI() {
    // „Éï„Ç£„É´„Çø„Éº„Éï„Ç©„Éº„É†„Åã„ÇâÁèæÂú®„ÅÆÂÄ§„ÇíÂèñÂæó
    const areaSelect = document.querySelector('select[name="area"]');
    const genreSelect = document.querySelector('select[name="genre"]');
    
    if (areaSelect) {
        currentFilters.area = areaSelect.value || 'all';
    }
    if (genreSelect) {
        currentFilters.genre = genreSelect.value || 'all';
    }
    
    console.log('üîç ÁèæÂú®„ÅÆ„Éï„Ç£„É´„Çø„Éº:', currentFilters);
}

// ÊúüÈñìÂàá„ÇäÊõø„Åà
function switchPeriod(period) {
    console.log(`üìÖ ÊúüÈñìÂàá„ÇäÊõø„Åà: ${period}`);
    currentPeriod = period;
    
    // „Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÊõ¥Êñ∞
    document.querySelectorAll('[id^="overall-period-"]').forEach(btn => {
        btn.className = 'px-3 py-1 text-sm font-medium rounded-md text-gray-600 hover:text-gray-900 transition-colors';
    });
    
    const activeBtn = document.getElementById(`overall-period-${period}`);
    if (activeBtn) {
        activeBtn.className = 'px-3 py-1 text-sm font-medium rounded-md bg-white text-gray-900 shadow-sm transition-colors';
    }
    
    // „Ç∞„É©„Éï„ÇíÂÜçË™≠„ÅøËæº„Åø
    loadOverallChart();
}

// ÂÖ®‰ΩìÁ®ºÂÉçÊé®Áßª„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
function loadOverallChart() {
    console.log('üìä ÂÖ®‰ΩìÁ®ºÂÉçÊé®Áßª„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...');
    
    // „Éï„Ç£„É´„Çø„ÉºÂÄ§„ÇíÊõ¥Êñ∞
    updateFiltersFromUI();
    
    // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÇíË°®Á§∫
    showLoadingState();
    
    // Áµ±Âêà„Åï„Çå„ÅüAPI„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÇíÊßãÁØâ
    const params = new URLSearchParams({
        chart_period: currentPeriod,
        area: currentFilters.area,
        genre: currentFilters.genre,
        include_chart_data: 'true',
        page: '1',
        page_size: '1'  // „ÉÅ„É£„Éº„Éà„Éá„Éº„Çø„ÅÆ„ÅøÂøÖË¶Å„Å™„ÅÆ„ÅßÊúÄÂ∞èÈôê
    });
    
    const url = `/api/stores?${params.toString()}`;
    console.log('üåê Áµ±ÂêàAPI URL:', url);
    
    fetch(url, {
        headers: {
            'Accept': 'application/json'
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üìä Áµ±ÂêàAPIÂÖ®‰Ωì„É¨„Çπ„Éù„É≥„Çπ:', data);
            
            // chart_data„Éó„É≠„Éë„ÉÜ„Ç£„Åã„Çâ„ÉÅ„É£„Éº„Éà„Éá„Éº„Çø„ÇíÂèñÂæó
            if (data.chart_data) {
                console.log('üìä ÂÖ®‰ΩìÁ®ºÂÉçÊé®Áßª„Éá„Éº„ÇøÂèó‰ø°:', data.chart_data);
                
                if (data.chart_data.success !== false) {
                    renderOverallChart(data.chart_data);
                } else {
                    console.error('‚ùå API„Ç®„É©„Éº:', data.chart_data.error);
                    showErrorState(data.chart_data.error || '„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } else {
                console.error('‚ùå chart_data„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                showErrorState('„ÉÅ„É£„Éº„Éà„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
            
            // ÂàùÊúüÂåñ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
            isInitializing = false;
        })
        .catch(error => {
            console.error('‚ùå Áµ±ÂêàAPIÂëº„Å≥Âá∫„Åó„Ç®„É©„Éº:', error);
            showErrorState('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            
            // ÂàùÊúüÂåñ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
            isInitializing = false;
        });
}



// „Ç∞„É©„Éï„ÇíÊèèÁîª
function renderOverallChart(apiData) {
    console.log('üé® ÂÖ®‰ΩìÁ®ºÂÉçÊé®Áßª„Ç∞„É©„Éï„ÇíÊèèÁîª‰∏≠...', apiData);
    
    const canvas = document.getElementById('overallChart');
    if (!canvas) {
        console.error('‚ùå „Ç≠„É£„É≥„Éê„ÇπË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Êó¢Â≠ò„ÅÆ„Ç∞„É©„Éï„ÇíÁ†¥Ê£Ñ
    if (overallChart) {
        overallChart.destroy();
    }
    
    // ÊúüÈñì„Å´Âøú„Åò„Å¶Âõ∫ÂÆö„ÅÆxËª∏„É©„Éô„É´„ÇíÁîüÊàê
    let fixedLabels = [];
    let chartData = [];
    
    if (currentPeriod === '7days') {
        // 7Êó•Èñì„ÅÆÂõ∫ÂÆö„É©„Éô„É´„ÇíÁîüÊàê
        const today = new Date();
        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            const label = `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
            fixedLabels.push(label);
            
            // API„Éá„Éº„Çø„Åã„ÇâÂØæÂøú„Åô„ÇãÂÄ§„ÇíÊé¢„Åô
            const dateStr = date.toISOString().split('T')[0];
            const apiIndex = (apiData.labels || []).findIndex(l => {
                // API„ÅÆ„É©„Éô„É´„ÅåMM/DDÂΩ¢Âºè„ÅÆÂ†¥Âêà„Å®YYYY-MM-DDÂΩ¢Âºè„ÅÆÂ†¥Âêà„Å´ÂØæÂøú
                return l === label || l.startsWith(dateStr) || l === dateStr;
            });
            chartData.push(apiIndex >= 0 ? (apiData.data || [])[apiIndex] : null);
        }
    } else if (currentPeriod === '2months') {
        // 8ÈÄ±Èñì„ÅÆÂõ∫ÂÆö„É©„Éô„É´„ÇíÁîüÊàê
        const today = new Date();
        for (let i = 7; i >= 0; i--) {
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - (i * 7) - (today.getDay() || 7) + 1); // ÈÄ±„ÅÆÂßã„Åæ„ÇäÔºàÊúàÊõúÊó•Ôºâ
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6); // ÈÄ±„ÅÆÁµÇ„Çè„ÇäÔºàÊó•ÊõúÊó•Ôºâ
            
            const formatDate = (date) => `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
            const label = `${formatDate(startDate)}-${formatDate(endDate)}`;
            fixedLabels.push(label);
            
            // API„Éá„Éº„Çø„Åã„ÇâÂØæÂøú„Åô„ÇãÂÄ§„ÇíÊé¢„ÅôÔºàÈÄ±„ÅÆÈñãÂßãÊó•„ÅßÊ§úÁ¥¢Ôºâ
            const weekStartStr = startDate.toISOString().split('T')[0];
            const apiIndex = (apiData.labels || []).findIndex(l => {
                return l === label || l.startsWith(weekStartStr);
            });
            chartData.push(apiIndex >= 0 ? (apiData.data || [])[apiIndex] : null);
        }
    }
    
    console.log('üìä Âõ∫ÂÆö„É©„Éô„É´:', fixedLabels);
    console.log('üìä „Éû„ÉÉ„Éî„É≥„Ç∞„Åï„Çå„Åü„Éá„Éº„Çø:', chartData);
    
    // „Éá„Éº„Çø„ÅåÂÖ®„Å¶Á©∫„ÅÆÂ†¥Âêà„ÅÆÂá¶ÁêÜ
    if (chartData.every(d => d === null)) {
        console.warn('‚ö†Ô∏è „Ç∞„É©„Éï„Éá„Éº„Çø„ÅåÁ©∫„Åß„Åô');
        showErrorState('Ë°®Á§∫„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
        return;
    }
    
    // Chart.js„ÅÆË®≠ÂÆö
    const config = {
        type: 'line',
        data: {
            labels: fixedLabels,
            datasets: [{
                label: 'Á®ºÂÉçÁéá (%)',
                data: chartData,
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#3B82F6',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8,
                spanGaps: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: false
                },
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#3B82F6',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y + '%';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        },
                        color: '#6B7280'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#6B7280'
                    }
                }
            },
            elements: {
                point: {
                    hoverBackgroundColor: '#1D4ED8'
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    };
    
    // „Ç∞„É©„Éï„Çí‰ΩúÊàê
    overallChart = new Chart(ctx, config);
    
    // „Éá„Éº„ÇøÊÉÖÂ†±„ÇíÊõ¥Êñ∞
    updateDataInfo(apiData);
    
    // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÇíÈùûË°®Á§∫
    hideLoadingState();
    
    // ÂàùÊúüÂåñ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
    isInitializing = false;
    
    console.log('‚úÖ ÂÖ®‰ΩìÁ®ºÂÉçÊé®Áßª„Ç∞„É©„Éï„ÅÆÊèèÁîªÂÆå‰∫Ü');
}

// „Éá„Éº„ÇøÊÉÖÂ†±„ÇíÊõ¥Êñ∞
function updateDataInfo(apiData) {
    const infoElement = document.getElementById('overall-chart-data-info');
    if (!infoElement) return;
    
    // „Éá„Éº„ÇøÊÉÖÂ†±Ë°®Á§∫„ÇíÁ©∫„Å´„Åô„Çã
    infoElement.innerHTML = '';
}

// „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÇíË°®Á§∫
function showLoadingState() {
    const chartContainer = document.getElementById('overallChart').parentElement;
    
    // Êó¢Â≠ò„ÅÆ„É≠„Éº„Éá„Ç£„É≥„Ç∞Ë¶ÅÁ¥†„ÇíÂâäÈô§
    const existingLoading = document.getElementById('overall-chart-loading');
    if (existingLoading) {
        existingLoading.remove();
    }
    
    // Êñ∞„Åó„ÅÑ„É≠„Éº„Éá„Ç£„É≥„Ç∞Ë¶ÅÁ¥†„Çí‰ΩúÊàê
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'overall-chart-loading';
    loadingDiv.className = 'absolute inset-0 flex items-center justify-center bg-white bg-opacity-90';
    loadingDiv.innerHTML = `
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-600 mb-3"></div>
            <div class="text-gray-600 text-sm animate-pulse">„Ç∞„É©„Éï„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
            <div class="flex space-x-1 mt-2">
                <div class="w-1.5 h-1.5 bg-gray-600 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                <div class="w-1.5 h-1.5 bg-gray-600 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                <div class="w-1.5 h-1.5 bg-gray-600 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
            </div>
        </div>
    `;
    
    chartContainer.style.position = 'relative';
    chartContainer.appendChild(loadingDiv);
}

// „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÇíÈùûË°®Á§∫
function hideLoadingState() {
    const loadingDiv = document.getElementById('overall-chart-loading');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

// „Ç®„É©„ÉºÁä∂ÊÖã„ÇíË°®Á§∫
function showErrorState(message = '„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü') {
    const chartContainer = document.getElementById('overallChart').parentElement;
    
    // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÇíÈùûË°®Á§∫
    hideLoadingState();
    
    // „Ç®„É©„ÉºË¶ÅÁ¥†„Çí‰ΩúÊàê
    const errorDiv = document.createElement('div');
    errorDiv.id = 'overall-chart-error';
    errorDiv.className = 'absolute inset-0 flex items-center justify-center bg-white';
    errorDiv.innerHTML = `
        <div class="text-red-500 text-center">
            <div class="mb-2">‚ö†Ô∏è</div>
            <div>${message}</div>
        </div>
    `;
    
    chartContainer.style.position = 'relative';
    chartContainer.appendChild(errorDiv);
    
    // ÂàùÊúüÂåñ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
    isInitializing = false;
}

// „Éï„Ç£„É´„Çø„ÉºÂ§âÊõ¥ÊôÇ„Å´„Ç∞„É©„Éï„ÇíÊõ¥Êñ∞
function updateOverallChart() {
    console.log('üîÑ „Éï„Ç£„É´„Çø„ÉºÂ§âÊõ¥„Å´„Çà„Çã„Ç∞„É©„ÉïÊõ¥Êñ∞');
    loadOverallChart();
}

// DOMContentLoadedÊôÇ„Å´ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ ÂÖ®‰ΩìÁ®ºÂÉçÊé®Áßª„Ç∞„É©„Éï„ÅÆÂàùÊúüÂåñÈñãÂßã');
    
    // Chart.js„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    if (typeof Chart === 'undefined') {
        console.error('‚ùå Chart.js„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
        showErrorState('„Ç∞„É©„Éï„É©„Ç§„Éñ„É©„É™„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        return;
    }
    
    // Â∞ë„ÅóÈÅÖÂª∂„Åó„Å¶„Åã„ÇâÂàùÊúüÂåñÔºà‰ªñ„ÅÆË¶ÅÁ¥†„ÅÆË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÂæÖ„Å§Ôºâ
    setTimeout(() => {
        initOverallChart();
        
        // ÊúüÈñìÂàá„ÇäÊõø„Åà„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
        const period7daysBtn = document.getElementById('overall-period-7days');
        const period2monthsBtn = document.getElementById('overall-period-2months');
        
        if (period7daysBtn) {
            period7daysBtn.addEventListener('click', () => {
                switchPeriod('7days');
                loadOverallChart();
            });
        }
        
        if (period2monthsBtn) {
            period2monthsBtn.addEventListener('click', () => {
                switchPeriod('2months');
                loadOverallChart();
            });
        }
    }, 500);
});

// HTMX„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÔºà„Éï„Ç£„É´„Çø„ÉºÂ§âÊõ¥ÊôÇÔºâ
document.addEventListener('htmx:afterSwap', function(event) {
    // Â∫óËàó‰∏ÄË¶ß„ÅåÊõ¥Êñ∞„Åï„Çå„ÅüÂæå„Å´„Ç∞„É©„Éï„ÇíÂÜçÂàùÊúüÂåñ
    if (event.target.id === 'store-list') {
        console.log('üîÑ Â∫óËàó‰∏ÄË¶ßÊõ¥Êñ∞Âæå„ÄÅÂÖ®‰ΩìÁ®ºÂÉçÊé®Áßª„Ç∞„É©„Éï„ÇíÂÜçÂàùÊúüÂåñ');
        
        // „Éï„Ç£„É´„Çø„ÉºÂ§âÊõ¥„Å´„Çà„ÇãÊõ¥Êñ∞„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        const triggerElement = event.detail.elt;
        const isFilterChange = triggerElement && triggerElement.hasAttribute('data-filter-change');
        
        if (isFilterChange) {
            console.log('üìä „Éï„Ç£„É´„Çø„ÉºÂ§âÊõ¥Ê§úÂá∫„ÄÅ„ÉÅ„É£„Éº„Éà„ÇíÊõ¥Êñ∞');
            // „Éï„Ç£„É´„Çø„ÉºÂ§âÊõ¥ÊôÇ„ÅØÁõ¥Êé•loadOverallChart„ÇíÂëº„Å≥Âá∫„Åó
            setTimeout(() => {
                updateFiltersFromUI();
                loadOverallChart();
            }, 100);
        } else {
            // ÈÄöÂ∏∏„ÅÆ„Éö„Éº„Ç∏„É≥„Ç∞Á≠â„ÅÆÂ†¥Âêà„ÅØÂàùÊúüÂåñ„Çí„Çπ„Ç≠„ÉÉ„Éó
            console.log('üìä „Éö„Éº„Ç∏„É≥„Ç∞Êõ¥Êñ∞„ÅÆ„Åü„ÇÅ„ÄÅ„Ç∞„É©„ÉïÂàùÊúüÂåñ„Çí„Çπ„Ç≠„ÉÉ„Éó');
        }
    }
});