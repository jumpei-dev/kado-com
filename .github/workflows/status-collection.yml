name: status collection

# =============================================================================
# ðŸš€ GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®šï¼ˆãƒžã‚¹ã‚¿ãƒ¼è¨­å®šï¼‰
# =============================================================================
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç¨¼åƒ.comã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨è¨­å®šã®ã€Œãƒžã‚¹ã‚¿ãƒ¼è¨­å®šã€ã§ã™ã€‚
# 
# ðŸ“‹ è¨­å®šã®å„ªå…ˆé †ä½:
# 1. GitHub Actionså®Ÿè¡Œæ™‚: ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®šãŒé©ç”¨
# 2. ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œæ™‚: config/config.yml ã®è¨­å®šãŒé©ç”¨
# 
# âš ï¸  é‡è¦: è¨­å®šå¤‰æ›´æ™‚ã¯ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã®åŒæœŸã‚’ä¿ã£ã¦ãã ã•ã„:
# - config/config.yml (scheduling.status_collection_interval: 120åˆ†)
# - batch/utils/config.py (SchedulingConfig.status_collection_interval: 120åˆ†)
# =============================================================================

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  schedule:
    # ðŸ• ç¨¼åƒçŠ¶æ³åŽé›†: 2æ™‚é–“ã”ã¨å®Ÿè¡Œï¼ˆconfig.ymlã¨çµ±ä¸€ï¼‰
    - cron: '0 */2 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      job_type:
        description: 'å®Ÿè¡Œã™ã‚‹ã‚¸ãƒ§ãƒ–ã‚¿ã‚¤ãƒ—'
        required: true
        default: 'status-collection'
        type: choice
        options:
        - status-collection
        - debug-html
      log_level:
        description: 'ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ï¼ˆå›ºå®šï¼šDEBUGï¼‰'
        required: false
        default: 'DEBUG'
        type: choice
        options:
        - DEBUG
      force_immediate:
        description: 'Status Collectionå³æ™‚å®Ÿè¡Œï¼ˆå¾…æ©Ÿæ™‚é–“ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰'
        required: false
        default: false
        type: boolean

# ã‚¸ãƒ§ãƒ–ã‚¿ã‚¤ãƒ—åˆ¥ã®ä¸¦åˆ—å®Ÿè¡Œåˆ¶å¾¡
concurrency:
  group: ${{ github.workflow }}-${{ github.event.inputs.job_type || 'status-collection' }}-${{ github.ref }}
  cancel-in-progress: true  # åŒã˜ã‚¸ãƒ§ãƒ–ã‚¿ã‚¤ãƒ—ã®é‡è¤‡å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«

jobs:
  batch-execution:
    name: ãƒãƒƒãƒã‚¸ãƒ§ãƒ–å®Ÿè¡Œ
    runs-on: ubuntu-latest
    timeout-minutes: 720  # 12æ™‚é–“ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã®ãŸã‚ï¼‰
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 1  # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã®ã¿å–å¾—
    
    - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'

    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # é–‹ç™ºç”¨ä¾å­˜é–¢ä¿‚ãŒã‚ã‚Œã°è¿½åŠ 
        # pip install -r requirements-dev.txt
    
    - name: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
      working-directory: batch
      run: |
        # è¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
        mkdir -p config
        
        # secret.ymlãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰ï¼‰
        cat > config/secret.yml << 'EOF'
        database:
          password: "${{ secrets.DB_PASSWORD }}"
          url: "${{ secrets.DATABASE_URL }}"
        
        auth:
          secret_key: "${{ secrets.JWT_SECRET_KEY }}"
        
        x_api:
          bearer_token: "${{ secrets.X_API_BEARER_TOKEN }}"
          consumer_key: "${{ secrets.X_API_CONSUMER_KEY }}"
          consumer_secret: "${{ secrets.X_API_CONSUMER_SECRET }}"
          access_token: "${{ secrets.X_API_ACCESS_TOKEN }}"
          access_token_secret: "${{ secrets.X_API_ACCESS_TOKEN_SECRET }}"
        EOF
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™è¨­å®šï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼‰
        chmod 600 config/secret.yml
    
    - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šãƒ†ã‚¹ãƒˆ
      working-directory: batch
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        LOG_LEVEL: ${{ github.event.inputs.log_level || 'INFO' }}
        PYTHONPATH: ${{ github.workspace }}/batch
      run: |
        echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™..."
        echo "ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)"
        echo "Pythonãƒ‘ã‚¹: $PYTHONPATH"
        ls -la
        
        python -c "
        import sys
        import logging
        import os
        
        # ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®è¨­å®š
        log_level = os.getenv('LOG_LEVEL', 'INFO')
        logging.basicConfig(level=getattr(logging, log_level))
        logger = logging.getLogger(__name__)
        
        # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®å‡ºåŠ›
        logger.debug(f'ç¾åœ¨ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: {os.getcwd()}')
        logger.debug(f'Pythonãƒ‘ã‚¹: {sys.path}')
        
        try:
            from core.database import DatabaseManager
            logger.info('DatabaseManagerã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ')
            
            db = DatabaseManager()
            logger.info('DatabaseManagerã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ')
            
            with db.get_connection() as conn:
                with conn.cursor() as cursor:
                    cursor.execute('SELECT 1 as test_value, NOW() as current_time')
                    result = cursor.fetchone()
                    logger.info(f'ãƒ†ã‚¹ãƒˆã‚¯ã‚¨ãƒªçµæžœ: {result}')
                    print('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ')
        except ImportError as e:
            logger.error(f'ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—: {e}')
            logger.error(f'ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: {os.getcwd()}')
            current_dir = '.';
            logger.error(f'åˆ©ç”¨å¯èƒ½ãªãƒ•ã‚¡ã‚¤ãƒ«: {os.listdir(current_dir)}' if os.path.exists(current_dir) else 'ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“')
            print('âŒ å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
            sys.exit(1)
        except Exception as e:
            logger.error(f'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šã‚¨ãƒ©ãƒ¼: {e}')
            print(f'âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: {e}')
            sys.exit(1)
        "
    
    - name: ãƒãƒƒãƒã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œ
      working-directory: batch
      env:
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        
        # èªè¨¼é–¢é€£
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        
        # X APIé–¢é€£
        X_API_BEARER_TOKEN: ${{ secrets.X_API_BEARER_TOKEN }}
        X_API_CONSUMER_KEY: ${{ secrets.X_API_CONSUMER_KEY }}
        X_API_CONSUMER_SECRET: ${{ secrets.X_API_CONSUMER_SECRET }}
        X_API_ACCESS_TOKEN: ${{ secrets.X_API_ACCESS_TOKEN }}
        X_API_ACCESS_TOKEN_SECRET: ${{ secrets.X_API_ACCESS_TOKEN_SECRET }}
        
        # ãƒ­ã‚°è¨­å®š
        LOG_LEVEL: ${{ github.event.inputs.log_level || 'INFO' }}
        
        # å®Ÿè¡Œåˆ¶å¾¡
        FORCE_IMMEDIATE: ${{ github.event.inputs.force_immediate || 'false' }}
        
        # å®Ÿè¡Œç’°å¢ƒ
        ENVIRONMENT: 'production'
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_RUN_NUMBER: ${{ github.run_number }}
      run: |
        # ã‚¸ãƒ§ãƒ–ã‚¿ã‚¤ãƒ—ã®å–å¾—
        JOB_TYPE="${{ github.event.inputs.job_type || 'status-collection' }}"
        echo "ðŸš€ ãƒãƒƒãƒã‚¸ãƒ§ãƒ–ã‚’é–‹å§‹ã—ã¾ã™: ${JOB_TYPE}"
        
        # ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
        mkdir -p logs
        
        # ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œ
        case "${JOB_TYPE}" in
          "status-collection")
            echo "ðŸ“Š ç¨¼åƒçŠ¶æ³åŽé›†ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œä¸­..."
            python main.py status-collection 2>&1 | tee logs/status-collection.log
            EXIT_CODE=${PIPESTATUS[0]}
            ;;

          "debug-html")
            echo "ðŸ” HTMLãƒ‡ãƒãƒƒã‚°ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œä¸­..."
            python main.py debug-html --local-file "sample.html" 2>&1 | tee logs/debug-html.log
            EXIT_CODE=${PIPESTATUS[0]}
            ;;
          *)
            echo "âŒ ä¸æ˜Žãªã‚¸ãƒ§ãƒ–ã‚¿ã‚¤ãƒ—: ${JOB_TYPE}"
            exit 1
            ;;
        esac
        
        # å®Ÿè¡Œçµæžœã®ç¢ºèª
        if [ ${EXIT_CODE} -eq 0 ]; then
          echo "âœ… ãƒãƒƒãƒã‚¸ãƒ§ãƒ–ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ (çµ‚äº†ã‚³ãƒ¼ãƒ‰: ${EXIT_CODE})"
        else
          echo "âŒ ãƒãƒƒãƒã‚¸ãƒ§ãƒ–ãŒå¤±æ•—ã—ã¾ã—ãŸ (çµ‚äº†ã‚³ãƒ¼ãƒ‰: ${EXIT_CODE})"
          exit ${EXIT_CODE}
        fi
    
    - name: ã‚¸ãƒ§ãƒ–å®Ÿè¡Œçµæžœã®è¦ç´„
      if: always()
      working-directory: batch
      run: |
        echo "## ðŸ“‹ ã‚¸ãƒ§ãƒ–å®Ÿè¡Œçµæžœã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "- **ã‚¸ãƒ§ãƒ–ã‚¿ã‚¤ãƒ—**: ${{ github.event.inputs.job_type || 'status-collection' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œæ™‚åˆ»**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡ŒID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œç•ªå·**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        
        # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã¨è¦ç´„
        if [ -d "logs" ] && [ "$(ls -A logs)" ]; then
          echo "- **ç”Ÿæˆã•ã‚ŒãŸãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«**:" >> $GITHUB_STEP_SUMMARY
          for log_file in logs/*.log; do
            if [ -f "$log_file" ]; then
              file_size=$(stat -f%z "$log_file" 2>/dev/null || stat -c%s "$log_file" 2>/dev/null || echo "ä¸æ˜Ž")
              echo "  - $(basename "$log_file") (${file_size} bytes)" >> $GITHUB_STEP_SUMMARY
            fi
          done
        else
          echo "- **ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«**: ãªã—" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: batch-logs-${{ github.event.inputs.job_type || 'status-collection' }}-${{ github.run_number }}
        path: batch/logs/
        retention-days: 30  # ãƒ­ã‚°ã®ä¿æŒæœŸé–“
        if-no-files-found: warn
    
    - name: å¤±æ•—æ™‚ã®é€šçŸ¥æº–å‚™
      if: failure()
      run: |
        echo "FAILURE_SUMMARY=ãƒãƒƒãƒã‚¸ãƒ§ãƒ– '${{ github.event.inputs.job_type || 'status-collection' }}' ãŒå¤±æ•—ã—ã¾ã—ãŸ (Run ID: ${{ github.run_id }})" >> $GITHUB_ENV
        echo "FAILURE_DETAILS=è©³ç´°ã¯ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_ENV
