name: status collection

# =============================================================================
# ðŸš€ GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®šï¼ˆãƒžã‚¹ã‚¿ãƒ¼è¨­å®šï¼‰
# =============================================================================
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç¨¼åƒ.comã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨è¨­å®šã®ã€Œãƒžã‚¹ã‚¿ãƒ¼è¨­å®šã€ã§ã™ã€‚
# 
# ðŸ“‹ è¨­å®šã®å„ªå…ˆé †ä½:
# 1. GitHub Actionså®Ÿè¡Œæ™‚: ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®šãŒé©ç”¨
# 2. ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œæ™‚: config/config.yml ã®è¨­å®šãŒé©ç”¨
# 
# âš ï¸  é‡è¦: è¨­å®šå¤‰æ›´æ™‚ã¯ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã®åŒæœŸã‚’ä¿ã£ã¦ãã ã•ã„:
# - config/config.yml (scheduling.status_collection_interval: 120åˆ†)
# - batch/utils/config.py (SchedulingConfig.status_collection_interval: 120åˆ†)
# =============================================================================

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  schedule:
    # ðŸ• ç¨¼åƒçŠ¶æ³åŽé›†: 2æ™‚é–“ã”ã¨å®Ÿè¡Œï¼ˆconfig.ymlã¨çµ±ä¸€ï¼‰
    # cronå¼ã®èª­ã¿æ–¹: 'åˆ† æ™‚ æ—¥ æœˆ æ›œæ—¥'
    # '0 */2 * * *' = æ¯Žæ—¥ã€2æ™‚é–“ãŠãï¼ˆ0:00, 2:00, 4:00, 6:00, 8:00, 10:00, 12:00, 14:00, 16:00, 18:00, 20:00, 22:00ï¼‰ã«å®Ÿè¡Œ
    # */2 ã¯ã€Œ2ã§å‰²ã‚Šåˆ‡ã‚Œã‚‹æ™‚é–“ã€ã‚’æ„å‘³ã™ã‚‹ãŸã‚ã€ç¢ºå®Ÿã«2æ™‚é–“é–“éš”ã§å®Ÿè¡Œã•ã‚Œã¾ã™
    - cron: '0 */2 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      job_type:
        description: 'å®Ÿè¡Œã™ã‚‹ã‚¸ãƒ§ãƒ–ã‚¿ã‚¤ãƒ—'
        required: true
        default: 'status-collection'
        type: choice
        options:
        - status-collection
        - debug-html
      log_level:
        description: 'ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ï¼ˆå›ºå®šï¼šDEBUGï¼‰'
        required: false
        default: 'DEBUG'
        type: choice
        options:
        - DEBUG
      force_immediate:
        description: 'Status Collectionå³æ™‚å®Ÿè¡Œï¼ˆå¾…æ©Ÿæ™‚é–“ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰'
        required: false
        default: false
        type: boolean

# ã‚¸ãƒ§ãƒ–ã‚¿ã‚¤ãƒ—åˆ¥ã®ä¸¦åˆ—å®Ÿè¡Œåˆ¶å¾¡
concurrency:
  group: ${{ github.workflow }}-${{ github.event.inputs.job_type || 'status-collection' }}-${{ github.ref }}
  cancel-in-progress: true  # åŒã˜ã‚¸ãƒ§ãƒ–ã‚¿ã‚¤ãƒ—ã®é‡è¤‡å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«

jobs:
  batch-execution:
    name: ãƒãƒƒãƒã‚¸ãƒ§ãƒ–å®Ÿè¡Œ
    runs-on: ubuntu-latest
    timeout-minutes: 720  # 12æ™‚é–“ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã®ãŸã‚ï¼‰
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 1  # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã®ã¿å–å¾—
    
    - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'

    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # é–‹ç™ºç”¨ä¾å­˜é–¢ä¿‚ãŒã‚ã‚Œã°è¿½åŠ 
        # pip install -r requirements-dev.txt
    
    - name: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
      working-directory: batch
      run: |
        # è¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
        mkdir -p config
        
        # secret.ymlãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰ï¼‰
        cat > config/secret.yml << 'EOF'
        database:
          password: "${{ secrets.DB_PASSWORD }}"
          url: "${{ secrets.DATABASE_URL }}"
        
        auth:
          secret_key: "${{ secrets.JWT_SECRET_KEY }}"
        
        # x_apiè¨­å®šã¯å‰Šé™¤æ¸ˆã¿
        EOF
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™è¨­å®šï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼‰
        chmod 600 config/secret.yml
    
    - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šãƒ†ã‚¹ãƒˆ
      working-directory: batch
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        LOG_LEVEL: ${{ github.event.inputs.log_level || 'INFO' }}
        PYTHONPATH: ${{ github.workspace }}/batch
      run: |
        echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™..."
        echo "ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)"
        echo "Pythonãƒ‘ã‚¹: $PYTHONPATH"
        ls -la
        
        python -c "
        import sys
        import logging
        import os
        
        # ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®è¨­å®š
        log_level = os.getenv('LOG_LEVEL', 'INFO')
        logging.basicConfig(level=getattr(logging, log_level))
        logger = logging.getLogger(__name__)
        
        # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®å‡ºåŠ›
        logger.debug(f'ç¾åœ¨ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: {os.getcwd()}')
        logger.debug(f'Pythonãƒ‘ã‚¹: {sys.path}')
        
        try:
            from core.database import DatabaseManager
            logger.info('DatabaseManagerã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ')
            
            db = DatabaseManager()
            logger.info('DatabaseManagerã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ')
            
            with db.get_connection() as conn:
                with conn.cursor() as cursor:
                    cursor.execute('SELECT 1 as test_value, NOW() as current_time')
                    result = cursor.fetchone()
                    logger.info(f'ãƒ†ã‚¹ãƒˆã‚¯ã‚¨ãƒªçµæžœ: {result}')
                    print('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ')
        except ImportError as e:
            logger.error(f'ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—: {e}')
            logger.error(f'ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: {os.getcwd()}')
            current_dir = '.';
            logger.error(f'åˆ©ç”¨å¯èƒ½ãªãƒ•ã‚¡ã‚¤ãƒ«: {os.listdir(current_dir)}' if os.path.exists(current_dir) else 'ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“')
            print('âŒ å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
            sys.exit(1)
        except Exception as e:
            logger.error(f'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šã‚¨ãƒ©ãƒ¼: {e}')
            print(f'âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: {e}')
            sys.exit(1)
        "
    
    - name: ãƒãƒƒãƒã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œ
      working-directory: batch
      env:
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        
        # èªè¨¼é–¢é€£
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        
        # X APIé–¢é€£ã®è¨­å®šã¯å‰Šé™¤æ¸ˆã¿
        
        # ãƒ­ã‚°è¨­å®š
        LOG_LEVEL: ${{ github.event.inputs.log_level || 'INFO' }}
        
        # å®Ÿè¡Œåˆ¶å¾¡
        FORCE_IMMEDIATE: ${{ github.event.inputs.force_immediate || 'false' }}
        
        # å®Ÿè¡Œç’°å¢ƒ
        ENVIRONMENT: 'production'
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_RUN_NUMBER: ${{ github.run_number }}
      run: |
        # ã‚¸ãƒ§ãƒ–ã‚¿ã‚¤ãƒ—ã®å–å¾—
        JOB_TYPE="${{ github.event.inputs.job_type || 'status-collection' }}"
        echo "ðŸš€ ãƒãƒƒãƒã‚¸ãƒ§ãƒ–ã‚’é–‹å§‹ã—ã¾ã™: ${JOB_TYPE}"
        
        # ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
        mkdir -p logs
        
        # ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œ
        case "${JOB_TYPE}" in
          "status-collection")
            echo "ðŸ“Š ç¨¼åƒçŠ¶æ³åŽé›†ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œä¸­..."
            python main.py status-collection 2>&1 | tee logs/status-collection.log
            EXIT_CODE=${PIPESTATUS[0]}
            ;;

          "debug-html")
            echo "ðŸ” HTMLãƒ‡ãƒãƒƒã‚°ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œä¸­..."
            python main.py debug-html --local-file "sample.html" 2>&1 | tee logs/debug-html.log
            EXIT_CODE=${PIPESTATUS[0]}
            ;;
          *)
            echo "âŒ ä¸æ˜Žãªã‚¸ãƒ§ãƒ–ã‚¿ã‚¤ãƒ—: ${JOB_TYPE}"
            exit 1
            ;;
        esac
        
        # å®Ÿè¡Œçµæžœã®ç¢ºèª
        if [ ${EXIT_CODE} -eq 0 ]; then
          echo "âœ… ãƒãƒƒãƒã‚¸ãƒ§ãƒ–ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ (çµ‚äº†ã‚³ãƒ¼ãƒ‰: ${EXIT_CODE})"
        else
          echo "âŒ ãƒãƒƒãƒã‚¸ãƒ§ãƒ–ãŒå¤±æ•—ã—ã¾ã—ãŸ (çµ‚äº†ã‚³ãƒ¼ãƒ‰: ${EXIT_CODE})"
          echo "ðŸ“‹ å¤±æ•—è©³ç´°æƒ…å ±:"
          echo "  - ã‚¸ãƒ§ãƒ–ã‚¿ã‚¤ãƒ—: ${JOB_TYPE}"
          echo "  - å®Ÿè¡Œæ™‚åˆ»: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "  - å®Ÿè¡ŒID: ${{ github.run_id }}"
          echo "  - å®Ÿè¡Œç•ªå·: ${{ github.run_number }}"
          echo "  - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: ${{ github.workflow }}"
          echo "  - ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
          echo "  - ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          
          # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’å‡ºåŠ›ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
          if [ -f "logs/${JOB_TYPE}.log" ]; then
            echo "ðŸ“„ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€å¾Œã®50è¡Œ:"
            echo "--- ãƒ­ã‚°é–‹å§‹ ---"
            tail -n 50 "logs/${JOB_TYPE}.log" || echo "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿å–ã‚Šã«å¤±æ•—"
            echo "--- ãƒ­ã‚°çµ‚äº† ---"
          else
            echo "âš ï¸  ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: logs/${JOB_TYPE}.log"
          fi
          
          # ç’°å¢ƒæƒ…å ±ã®å‡ºåŠ›
          echo "ðŸ”§ ç’°å¢ƒæƒ…å ±:"
          echo "  - Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $(python --version 2>&1)"
          echo "  - ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)"
          echo "  - ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡: $(df -h . | tail -1)"
          echo "  - ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: $(free -h | head -2 | tail -1 || echo 'ãƒ¡ãƒ¢ãƒªæƒ…å ±å–å¾—ä¸å¯')"
          
          # ã‚µãƒ¼ãƒãƒ¼æ‹’å¦ãƒ»botæ¤œçŸ¥å¯¾ç­–ã®è©³ç´°æƒ…å ±
          echo "ðŸš« ã‚µãƒ¼ãƒãƒ¼æ‹’å¦ãƒ»botæ¤œçŸ¥å¯¾ç­–ã®è©³ç´°:"
          python -c "
import sys
import os
sys.path.append('.')
try:
    from utils.config import Config
    from core.scraper import ScraperConfig
    config = Config()
    scraper_config = ScraperConfig()
    
    print('  ðŸ“¡ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š:')
    print(f'    - ãƒ—ãƒ­ã‚­ã‚·æœ‰åŠ¹: {getattr(scraper_config, \"use_proxy\", \"ä¸æ˜Ž\")}')
    print(f'    - ãƒ—ãƒ­ã‚­ã‚·ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³: {getattr(scraper_config, \"proxy_rotation\", \"ä¸æ˜Ž\")}')
    print(f'    - User-Agent ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³: {getattr(scraper_config, \"ua_rotation\", \"ä¸æ˜Ž\")}')
    print(f'    - ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“éš”: {getattr(scraper_config, \"request_interval\", \"ä¸æ˜Ž\")}ç§’')
    print(f'    - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š: {getattr(scraper_config, \"timeout\", \"ä¸æ˜Ž\")}ç§’')
    
    print('  ðŸ” æœ€æ–°ã®HTTPã‚¨ãƒ©ãƒ¼æƒ…å ±:')
    # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰HTTPã‚¨ãƒ©ãƒ¼ã‚’æŠ½å‡º
    import glob
    log_files = glob.glob('logs/*.log')
    for log_file in log_files[-3:]:  # æœ€æ–°3ãƒ•ã‚¡ã‚¤ãƒ«
        try:
            with open(log_file, 'r', encoding='utf-8') as f:
                lines = f.readlines()[-100:]  # æœ€å¾Œã®100è¡Œ
                for line in lines:
                    if any(keyword in line.lower() for keyword in ['403', '429', '503', 'blocked', 'captcha', 'bot']):
                        print(f'    - {line.strip()}')
        except Exception:
            pass
except Exception as e:
    print(f'  âŒ è©³ç´°æƒ…å ±ã®å–å¾—ã«å¤±æ•—: {e}')
" || echo "  âŒ è©³ç´°æƒ…å ±ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œã«å¤±æ•—"
          
          exit ${EXIT_CODE}
        fi
    
    - name: ã‚¸ãƒ§ãƒ–å®Ÿè¡Œçµæžœã®è¦ç´„
      if: always()
      working-directory: batch
      run: |
        echo "## ðŸ“‹ ã‚¸ãƒ§ãƒ–å®Ÿè¡Œçµæžœã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "- **ã‚¸ãƒ§ãƒ–ã‚¿ã‚¤ãƒ—**: ${{ github.event.inputs.job_type || 'status-collection' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œæ™‚åˆ»**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡ŒID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œç•ªå·**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        
        # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã¨è¦ç´„
        if [ -d "logs" ] && [ "$(ls -A logs)" ]; then
          echo "- **ç”Ÿæˆã•ã‚ŒãŸãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«**:" >> $GITHUB_STEP_SUMMARY
          for log_file in logs/*.log; do
            if [ -f "$log_file" ]; then
              file_size=$(stat -f%z "$log_file" 2>/dev/null || stat -c%s "$log_file" 2>/dev/null || echo "ä¸æ˜Ž")
              echo "  - $(basename "$log_file") (${file_size} bytes)" >> $GITHUB_STEP_SUMMARY
            fi
          done
        else
          echo "- **ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«**: ãªã—" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: batch-logs-${{ github.event.inputs.job_type || 'status-collection' }}-${{ github.run_number }}
        path: batch/logs/
        retention-days: 30  # ãƒ­ã‚°ã®ä¿æŒæœŸé–“
        if-no-files-found: warn
    
    - name: å¤±æ•—æ™‚ã®é€šçŸ¥æº–å‚™
      if: failure()
      run: |
        echo "FAILURE_SUMMARY=ãƒãƒƒãƒã‚¸ãƒ§ãƒ– '${{ github.event.inputs.job_type || 'status-collection' }}' ãŒå¤±æ•—ã—ã¾ã—ãŸ (Run ID: ${{ github.run_id }})" >> $GITHUB_ENV
        echo "FAILURE_DETAILS=è©³ç´°ã¯ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_ENV
