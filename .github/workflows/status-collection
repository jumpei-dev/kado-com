name: Status Collection Job

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  schedule:
    # 30åˆ†ã”ã¨ã«ç¨¼åƒçŠ¶æ³å–å¾—ã‚’å®Ÿè¡Œ
    - cron: '*/30 * * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      log_level:
        description: 'ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«'
        required: false
        default: 'INFO'
        type: choice
        options:
        - DEBUG
        - INFO
        - WARNING
        - ERROR

# ç’°å¢ƒå¤‰æ•°
env:
  PYTHON_VERSION: '3.11'

# ä¸¦åˆ—å®Ÿè¡Œåˆ¶å¾¡
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  status-collection:
    name: ç¨¼åƒçŠ¶æ³åŽé›†ã‚¸ãƒ§ãƒ–
    runs-on: ubuntu-latest
    timeout-minutes: 20  # status-collectionã¯æ¯”è¼ƒçš„çŸ­æ™‚é–“ã§å®Œäº†
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'

    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
      working-directory: batch
      run: |
        mkdir -p config
        
        cat > config/secret.yml << 'EOF'
        database:
          password: "${{ secrets.DB_PASSWORD }}"
          url: "${{ secrets.DATABASE_URL }}"
        
        auth:
          secret_key: "${{ secrets.JWT_SECRET_KEY }}"
        
        x_api:
          bearer_token: "${{ secrets.X_API_BEARER_TOKEN }}"
          consumer_key: "${{ secrets.X_API_CONSUMER_KEY }}"
          consumer_secret: "${{ secrets.X_API_CONSUMER_SECRET }}"
          access_token: "${{ secrets.X_API_ACCESS_TOKEN }}"
          access_token_secret: "${{ secrets.X_API_ACCESS_TOKEN_SECRET }}"
        EOF
        
        chmod 600 config/secret.yml
    
    - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šãƒ†ã‚¹ãƒˆ
      working-directory: batch
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        LOG_LEVEL: ${{ github.event.inputs.log_level || 'INFO' }}
        PYTHONPATH: ${{ github.workspace }}/batch
      run: |
        echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™..."
        python -c "
        import sys
        import logging
        import os
        
        log_level = os.getenv('LOG_LEVEL', 'INFO')
        logging.basicConfig(level=getattr(logging, log_level))
        logger = logging.getLogger(__name__)
        
        try:
            from core.database import DatabaseManager
            logger.info('DatabaseManagerã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ')
            
            db = DatabaseManager()
            logger.info('DatabaseManagerã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ')
            
            with db.get_connection() as conn:
                with conn.cursor() as cursor:
                    cursor.execute('SELECT 1 as test_value, NOW() as current_time')
                    result = cursor.fetchone()
                    logger.info(f'ãƒ†ã‚¹ãƒˆã‚¯ã‚¨ãƒªçµæžœ: {result}')
                    print('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ')
        except Exception as e:
            logger.error(f'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šã‚¨ãƒ©ãƒ¼: {e}')
            print(f'âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: {e}')
            sys.exit(1)
        "
    
    - name: ç¨¼åƒçŠ¶æ³åŽé›†ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œ
      working-directory: batch
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        X_API_BEARER_TOKEN: ${{ secrets.X_API_BEARER_TOKEN }}
        X_API_CONSUMER_KEY: ${{ secrets.X_API_CONSUMER_KEY }}
        X_API_CONSUMER_SECRET: ${{ secrets.X_API_CONSUMER_SECRET }}
        X_API_ACCESS_TOKEN: ${{ secrets.X_API_ACCESS_TOKEN }}
        X_API_ACCESS_TOKEN_SECRET: ${{ secrets.X_API_ACCESS_TOKEN_SECRET }}
        LOG_LEVEL: ${{ github.event.inputs.log_level || 'INFO' }}
        ENVIRONMENT: 'production'
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_RUN_NUMBER: ${{ github.run_number }}
      run: |
        echo "ðŸ“Š ç¨¼åƒçŠ¶æ³åŽé›†ã‚¸ãƒ§ãƒ–ã‚’é–‹å§‹ã—ã¾ã™..."
        
        mkdir -p logs
        
        python main.py status-collection 2>&1 | tee logs/status-collection.log
        EXIT_CODE=${PIPESTATUS[0]}
        
        if [ ${EXIT_CODE} -eq 0 ]; then
          echo "âœ… ç¨¼åƒçŠ¶æ³åŽé›†ã‚¸ãƒ§ãƒ–ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ (çµ‚äº†ã‚³ãƒ¼ãƒ‰: ${EXIT_CODE})"
        else
          echo "âŒ ç¨¼åƒçŠ¶æ³åŽé›†ã‚¸ãƒ§ãƒ–ãŒå¤±æ•—ã—ã¾ã—ãŸ (çµ‚äº†ã‚³ãƒ¼ãƒ‰: ${EXIT_CODE})"
          exit ${EXIT_CODE}
        fi
    
    - name: ã‚¸ãƒ§ãƒ–å®Ÿè¡Œçµæžœã®è¦ç´„
      if: always()
      working-directory: batch
      run: |
        echo "## ðŸ“‹ ç¨¼åƒçŠ¶æ³åŽé›†ã‚¸ãƒ§ãƒ–å®Ÿè¡Œçµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œæ™‚åˆ»**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡ŒID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œç•ªå·**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "logs" ] && [ "$(ls -A logs)" ]; then
          echo "- **ç”Ÿæˆã•ã‚ŒãŸãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«**:" >> $GITHUB_STEP_SUMMARY
          for log_file in logs/*.log; do
            if [ -f "$log_file" ]; then
              file_size=$(stat -f%z "$log_file" 2>/dev/null || stat -c%s "$log_file" 2>/dev/null || echo "ä¸æ˜Ž")
              echo "  - $(basename "$log_file") (${file_size} bytes)" >> $GITHUB_STEP_SUMMARY
            fi
          done
        else
          echo "- **ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«**: ãªã—" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: status-collection-logs-${{ github.run_number }}
        path: batch/logs/
        retention-days: 30
        if-no-files-found: warn
    
    - name: å¤±æ•—æ™‚ã®é€šçŸ¥æº–å‚™
      if: failure()
      run: |
        echo "FAILURE_SUMMARY=ç¨¼åƒçŠ¶æ³åŽé›†ã‚¸ãƒ§ãƒ–ãŒå¤±æ•—ã—ã¾ã—ãŸ (Run ID: ${{ github.run_id }})" >> $GITHUB_ENV
        echo "FAILURE_DETAILS=è©³ç´°ã¯ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_ENV
